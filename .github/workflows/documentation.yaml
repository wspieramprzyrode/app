name: Build and publish documentation

on:
  push:
    branches:
    - master
    paths:
    - 'docusaurus/**'
    - 'github/workflows/documentation.yaml'
  pull_request:
    paths:
    - 'docusaurus/**'
jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master

    - name: setup node
      uses: actions/setup-node@v1
      with:
        node-version: '12'

    - name: install
      working-directory: ./docusaurus/website
      run: npm install

    - name: write translations files
      working-directory: ./docusaurus/website
      run: npm run write-translations

    - name: build
      working-directory: ./docusaurus/website
      run: npm run build

    - name: deploy
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/master'
      with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docusaurus/website/build/app
          cname: docs.wspieramprzyrode.pl
  docker-build:
    runs-on: ubuntu-latest
    needs: build-deploy
    name: Docker Build, Tag, Push
    if: github.ref == 'refs/heads/master'
    steps:
    - name: Checkout
      uses: actions/checkout@master

    - name: Publish to docker registry
      uses: mr-smithers-excellent/docker-build-push@v3
      with:
        image: wspieramprzyrode/docs
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        registry: docker.io
        directory: docusaurus
        dockerfile: docusaurus/Dockerfile